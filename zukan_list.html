<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>図鑑一覧</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Mochiy+Pop+P+One&display=swap" rel="stylesheet">
</head>
<body class="fantasy-theme">
  <header>
    <h1>図鑑一覧</h1>
  </header>

  <main class="main-container">
    <div id="zukan-list" class="list-grid"></div>
    <div id="map"></div>
  </main>

  <nav class="bottom-nav sp-only">
    <a href="index.html" class="nav-item">
      <span class="icon">🏠</span><br>ホーム
    </a>
    <a href="zukan_list.html" class="nav-item">
      <span class="icon">📚</span><br>図鑑一覧
    </a>
    <a href="create_zukan.html" class="nav-item plus-item">
      <span class="icon">➕</span><br>作成
    </a>
  </nav>

  <script src="script.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      renderList();
      renderMap();
    });

    // ===== 一覧描画 =====
    function renderList() {
      const container = document.getElementById("zukan-list");
      container.innerHTML = "";

      const zukans = getZukans();
      zukans.forEach(zukan => {
        const item = document.createElement("div");
        item.className = "list-item";

        // 表紙画像を取得 (最初の写真、なければデフォルト画像)
        const coverImage = zukan.photos && zukan.photos.length > 0 ? zukan.photos[0].image : 'https://placehold.jp/120x120.png?text=No%20Image';

        item.innerHTML = `
          <img src="${coverImage}" alt="${zukan.name}の表紙" class="cover-image">
          <h3>${zukan.name}</h3>
          <div class="item-buttons">
            <button onclick="viewZukan('${zukan.id}')">🔍 閲覧</button>
            <button onclick="addPhoto('${zukan.id}')">📷 追加</button>
            <button onclick="if(confirm('${zukan.name} を削除しますか？')) deleteZukan('${zukan.id}')">🗑 削除</button>
          </div>
        `;

        container.appendChild(item);
      });
    }

    function viewZukan(id) {
      localStorage.setItem("currentZukanId", id);
      window.location.href = "zukan_view.html";
    }

    function addPhoto(id) {
      localStorage.setItem("currentZukanId", id);
      window.location.href = "add_photo.html";
    }

    // ===== マップ描画 =====
    function renderMap() {
      const map = L.map("map").setView([38.2688, 140.8719], 13); // 仙台

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      const zukans = getZukans();
      zukans.forEach(zukan => {
        if (zukan.photos) {
          zukan.photos.forEach(photo => {
            if (photo.lat && photo.lng) {
              const marker = L.marker([photo.lat, photo.lng]).addTo(map);
              marker.bindPopup(
                `<b>${photo.name}</b><br>
                 <img src="${photo.image}" width="100"><br>
                 ${photo.description || ''}`
              );
            }
          });
        }
      });
    }

  </script>
</body>
</html>
